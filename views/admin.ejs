<!DOCTYPE html>
<html>
  <head>
    <title>Admin Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      .order-card {
        background: white;
        border: 1px solid #ddd;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .order-card.special-rate {
        border-left: 5px solid #ff6b35;
        background: #fff8f5;
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .special-rate-indicator {
        background: #ff6b35;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        margin-left: 10px;
      }

      .special-rate-details {
        background: #fff3e0;
        border: 1px solid #ffcc80;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 12px;
      }

      .special-rate-details ul {
        margin: 5px 0;
        padding-left: 20px;
      }

      .customer-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
      }

      .order-items table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
      }

      .order-items th,
      .order-items td {
        padding: 8px;
        border: 1px solid #dee2e6;
        text-align: left;
      }

      .order-items th {
        background-color: #f8f9fa;
      }

      .controls {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid #ffeaa7;
      }

      .control-row {
        display: flex;
        gap: 15px;
        margin: 10px 0;
        align-items: end;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      .control-group label {
        font-size: 12px;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .control-group input {
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        width: 100px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
      }
      .btn-warning {
        background-color: #ffc107;
        color: #000;
      }
      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .order-summary {
        background: #e7f3ff;
        padding: 15px;
        border: 1px solid #b3d7ff;
        border-radius: 4px;
        margin: 15px 0;
      }

      .pricing-comparison {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 12px;
        border-left: 3px solid #6c757d;
      }

      .balance-positive {
        color: #28a745;
        font-weight: bold;
      }
      .balance-negative {
        color: #dc3545;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Admin Dashboard</h1>

    <!-- Customer Balance Summary -->
    <% if (customerSummary && customerSummary.length > 0) { %>
    <div
      style="
        background: #fff3cd;
        border: 2px solid #ffc107;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      "
    >
      <h2 style="margin: 0 0 15px 0; color: #856404">
        ⚠ Outstanding Customer Balances
      </h2>
      <div style="display: grid; gap: 10px">
        <% customerSummary.forEach(customer => { %>
        <div
          style="
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #dc3545;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <strong><%= customer.name %></strong> (<%= customer.email %>)
            <br />
            <small style="color: #666"
              ><%= customer.orderCount %> order<%= customer.orderCount > 1 ? 's'
              : '' %></small
            >
          </div>
          <div style="text-align: right">
            <div style="font-size: 18px; font-weight: bold; color: #dc3545">
              $<%= customer.totalBalance.toFixed(2) %>
            </div>
            <small style="color: #666">total owed</small>
          </div>
        </div>
        <% }); %>
      </div>
    </div>
    <% } %> <% if (orders.length === 0) { %>
    <p>No orders found.</p>
    <% } else { %>

    <h2>All Orders</h2>
    <% orders.forEach(order => { %>
    <div class="order-card <%= order.hasSpecialRate ? 'special-rate' : '' %>">
      <!-- Order Header -->
      <div class="order-header">
        <h3>
          Order #<%= order.order_id %> <% if (order.hasSpecialRate) { %>
          <span class="special-rate-indicator">*Special Rate Applied</span>
          <% } %>
        </h3>
        <span><%= new Date(order.order_date).toLocaleString() %></span>
      </div>

      <!-- Special Rate Details -->
      <% if (order.hasSpecialRate && order.specialRateType.length > 0) { %>
      <div class="special-rate-details">
        <strong>Special Rate Applied:</strong>
        <ul>
          <% order.specialRateType.forEach(type => { %>
          <li><%= type %></li>
          <% }); %>
        </ul>
      </div>
      <% } %>

      <!-- Customer Info -->
      <div class="customer-info">
        <h4>Customer Details</h4>
        <p><strong>Name:</strong> <%= order.name %></p>
        <p><strong>Phone:</strong> <%= order.phone %></p>
        <p><strong>Email:</strong> <%= order.email %></p>
        <p><strong>Address:</strong> <%= order.address %></p>
      </div>

      <!-- Order Items -->
      <div class="order-items">
        <h4>Items Ordered</h4>
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Price</th>
            </tr>
          </thead>
          <tbody>
            <% order.items.forEach(item => { %>
            <tr>
              <td><%= item.color %> <%= item.variant %></td>
              <td><%= item.quantity %></td>
              <td>$<%= item.subtotal.toFixed(2) %></td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h4>Order Summary</h4>
        <p>
          <strong>Items Subtotal:</strong> $<%= order.itemsSubtotal.toFixed(2)
          %>
        </p>
        <p>
          <strong>Delivery Fee:</strong> $<%= order.delivery_fee.toFixed(2) %>
          <em>(<%= getDeliveryRateInfo(order.itemsSubtotal).rate %>)</em>
          <% if (Math.abs(order.delivery_fee - order.standardDeliveryFee) >
          0.01) { %>
          <em style="color: #ff6b35">
            (Standard: $<%= order.standardDeliveryFee.toFixed(2) %>)
          </em>
          <% } %>
        </p>
        <p>
          <strong>Total Price:</strong> $<%= order.total_price.toFixed(2) %> <%
          if (order.total_price < order.standardTotal - 0.01) { %>
          <em style="color: #ff6b35">
            (Standard: $<%= order.standardTotal.toFixed(2) %>)
          </em>
          <% } %>
        </p>
        <p><strong>Payments Made:</strong> $<%= order.payments.toFixed(2) %></p>
        <p>
          <strong>Balance Due:</strong>
          <span
            class="<%= order.balance <= 0 ? 'balance-positive' : 'balance-negative' %>"
          >
            $<%= order.balance.toFixed(2) %>
          </span>
        </p>
        <p><strong>Status:</strong> <%= order.status %></p>
      </div>

      <!-- Pricing Comparison (for special rate orders) -->
      <% if (order.hasSpecialRate) { %>
      <div class="pricing-comparison">
        <strong>Pricing Comparison:</strong><br />
        Standard Total: $<%= order.standardTotal.toFixed(2) %> | Current Total:
        $<%= order.total_price.toFixed(2) %> | <% if (order.standardTotal >
        order.total_price) { %>
        <span style="color: #28a745"
          >Savings: $<%= (order.standardTotal - order.total_price).toFixed(2)
          %></span
        >
        <% } else if (order.standardTotal < order.total_price) { %>
        <span style="color: #dc3545"
          >Additional: $<%= (order.total_price - order.standardTotal).toFixed(2)
          %></span
        >
        <% } %>
      </div>
      <% } %>

      <!-- Admin Controls -->
      <div class="controls">
        <h4>Admin Controls</h4>

        <div class="control-row">
          <!-- Record Payment -->
          <form method="POST" action="/admin/pay/<%= order.order_id %>">
            <div class="control-group">
              <label>Record Payment:</label>
              <input
                type="number"
                name="payment"
                step="0.01"
                min="0.01"
                placeholder="Amount"
                required
              />
            </div>
            <button type="submit" class="btn btn-success">
              Record Payment
            </button>
          </form>

          <!-- Adjust Delivery Fee -->
          <form
            method="POST"
            action="/admin/adjust-delivery/<%= order.order_id %>"
          >
            <div class="control-group">
              <label>Delivery Fee:</label>
              <input
                type="number"
                name="delivery_fee"
                step="0.01"
                min="0"
                value="<%= order.delivery_fee.toFixed(2) %>"
                required
              />
            </div>
            <button type="submit" class="btn btn-warning">
              Update Delivery
            </button>
          </form>

          <!-- Apply Discount -->
          <form
            method="POST"
            action="/admin/add-discount/<%= order.order_id %>"
          >
            <div class="control-group">
              <label>Apply Discount:</label>
              <input
                type="number"
                name="discount"
                step="0.01"
                min="0.01"
                placeholder="Amount"
                required
              />
            </div>
            <button type="submit" class="btn btn-danger">Apply Discount</button>
          </form>
        </div>

        <!-- Order Status Controls -->
        <div
          class="control-row"
          style="
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
          "
        >
          <% if (order.status === 'open') { %>
          <!-- Mark as Delivered -->
          <form
            method="POST"
            action="/admin/mark-delivered/<%= order.order_id %>"
          >
            <button
              type="submit"
              class="btn btn-primary"
              onclick="return confirm('Mark this order as delivered?')"
            >
              ✓ Mark as Delivered
            </button>
          </form>
          <% } else { %>
          <!-- Reopen Order -->
          <form method="POST" action="/admin/reopen/<%= order.order_id %>">
            <button
              type="submit"
              class="btn btn-warning"
              onclick="return confirm('Reopen this order?')"
            >
              ↻ Reopen Order
            </button>
          </form>
          <% } %>

          <!-- Order Status Display -->
          <div style="display: flex; align-items: center; margin-left: 15px">
            <strong>Status: </strong>
            <span
              style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 5px; background-color: <%= order.status === 'open' ? '#28a745' : '#6c757d' %>; color: white;"
            >
              <%= order.status === 'open' ? 'OPEN' : 'DELIVERED' %>
            </span>
          </div>
        </div>
      </div>
    </div>
    <% }); %> <% } %>
  </body>
</html>
